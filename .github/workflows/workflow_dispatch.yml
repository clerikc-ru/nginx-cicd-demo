name: üîç Test Ingress Access

on:
  workflow_dispatch:
  push:
    tags:
      - 'v-*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üîß Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: üîê Load Kubeconfig
      run: |
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > /tmp/kubeconfig.yaml
        export KUBECONFIG=/tmp/kubeconfig.yaml
        kubectl get nodes

    - name: üèóÔ∏è Deploy Infrastructure
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "=== Deploying Infrastructure ==="
        kubectl apply -f k8s/infrastructure/ingress-controller.yaml
        sleep 10

    - name: üõ†Ô∏è Deploy Test Application
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        
        echo "=== Deploying Test Application ==="
        kubectl create configmap nginx-html --from-file=html/index.html -o yaml --dry-run=client | kubectl apply -f -
        kubectl create configmap nginx-config --from-file=nginx-config/nginx.conf -o yaml --dry-run=client | kubectl apply -f -
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        
        echo "‚è≥ Waiting for application..."
        sleep 20

    - name: üåê –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—Å–µ –ø–æ—Ä—Ç—ã
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        SERVER_IP="185.8.22.53"
        
        echo "=== 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–æ–≤ ==="
        nc -zv $SERVER_IP 80 && echo "‚úÖ –ü–æ—Ä—Ç 80 –æ—Ç–∫—Ä—ã—Ç" || echo "‚ùå –ü–æ—Ä—Ç 80 –∑–∞–∫—Ä—ã—Ç"
        nc -zv $SERVER_IP 443 && echo "‚úÖ –ü–æ—Ä—Ç 443 –æ—Ç–∫—Ä—ã—Ç" || echo "‚ùå –ü–æ—Ä—Ç 443 –∑–∞–∫—Ä—ã—Ç"
        nc -zv $SERVER_IP 30080 && echo "‚úÖ –ü–æ—Ä—Ç 30080 –æ—Ç–∫—Ä—ã—Ç" || echo "‚ùå –ü–æ—Ä—Ç 30080 –∑–∞–∫—Ä—ã—Ç"
        nc -zv $SERVER_IP 30443 && echo "‚úÖ –ü–æ—Ä—Ç 30443 –æ—Ç–∫—Ä—ã—Ç" || echo "‚ùå –ü–æ—Ä—Ç 30443 –∑–∞–∫—Ä—ã—Ç"
        
        echo "=== 2. –¢–µ—Å—Ç–∏—Ä—É–µ–º HTTP –Ω–∞ –ø–æ—Ä—Ç—É 80 ==="
        curl -v --connect-timeout 10 http://$SERVER_IP:80/ 2>&1 | head -20
        
        echo "=== 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º HTTP –Ω–∞ –ø–æ—Ä—Ç—É 30080 ==="
        curl -v --connect-timeout 10 http://$SERVER_IP:30080/ 2>&1 | head -20
        
        echo "=== 4. –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å Host header –Ω–∞ –ø–æ—Ä—Ç—É 80 ==="
        curl -v --connect-timeout 10 -H "Host: clerikc.ru" http://$SERVER_IP:80/ 2>&1 | head -20
        
        echo "=== 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ ingress ==="
        kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx --tail=10

    - name: üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Ingress Controller
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        
        echo "=== 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º Ingress Controller ==="
        kubectl get service -n ingress-nginx
        
        echo "=== 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω–µ—à–Ω–∏–π IP —Å–µ—Ä–≤–µ—Ä–∞ ==="
        SERVER_IP="185.8.22.53"
        echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ IP: $SERVER_IP"
        
        echo "=== 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTP —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç 80 ==="
        curl -f http://$SERVER_IP:80 && echo "‚úÖ HTTP –Ω–∞ –ø–æ—Ä—Ç—É 80 –†–ê–ë–û–¢–ê–ï–¢!" || echo "‚ùå HTTP –Ω–∞ –ø–æ—Ä—Ç—É 80 –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
        
        echo "=== 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å Host header ==="
        curl -f -H "Host: clerikc.ru" http://$SERVER_IP:80 && echo "‚úÖ HTTP —Å Host header –†–ê–ë–û–¢–ê–ï–¢!" || echo "‚ùå HTTP —Å Host header –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
        
        echo "=== 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ—Ä—Ç—ã 30080/30443 ==="
        curl -f http://$SERVER_IP:30080 && echo "‚úÖ HTTP –Ω–∞ 30080 –†–ê–ë–û–¢–ê–ï–¢!" || echo "‚ùå HTTP –Ω–∞ 30080 –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"

    - name: üîç Debug if Failed
      if: failure()
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "=== –î–ï–¢–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ==="
        kubectl describe service -n ingress-nginx
        kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx --tail=20
        kubectl get ingress -A
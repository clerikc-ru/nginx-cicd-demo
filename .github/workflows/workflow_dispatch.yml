name: üîç Test Ingress Access

on:
  workflow_dispatch:
  push:
    tags:
      - 'v-*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üîß Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: üîê Load Kubeconfig
      run: |
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > /tmp/kubeconfig.yaml
        export KUBECONFIG=/tmp/kubeconfig.yaml
        kubectl get nodes

    - name: üèóÔ∏è Deploy Infrastructure
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "=== Deploying Infrastructure ==="
        kubectl apply -f k8s/infrastructure/ingress-controller.yaml
        sleep 10

    - name: üõ†Ô∏è Deploy Test Application
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        
        echo "=== Deploying Test Application ==="
        kubectl create configmap nginx-html --from-file=html/index.html -o yaml --dry-run=client | kubectl apply -f -
        kubectl create configmap nginx-config --from-file=nginx-config/nginx.conf -o yaml --dry-run=client | kubectl apply -f -
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        
        echo "‚è≥ Waiting for application..."
        sleep 20

    - name: üåê Test Ingress Access
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        
        echo "=== 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–∏—Å—ã ==="
        kubectl get service -n ingress-nginx
        kubectl get pods -n ingress-nginx
        kubectl get pods -l app=nginx-cicd-demo
        
        echo "=== 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω–µ—à–Ω–∏–π IP —Å–µ—Ä–≤–µ—Ä–∞ ==="
        SERVER_IP="185.8.22.53"
        echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ IP: $SERVER_IP"
        
        echo "=== 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä—è–º–æ–µ HTTP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ä—Ç 80 ==="
        curl -v --connect-timeout 10 http://$SERVER_IP:80/ && echo "‚úÖ HTTP –Ω–∞ –ø–æ—Ä—Ç—É 80 –†–ê–ë–û–¢–ê–ï–¢!" || echo "‚ùå HTTP –Ω–∞ –ø–æ—Ä—Ç—É 80 –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
        
        echo "=== 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å Host header (–∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ clerikc.ru) ==="
        curl -v --connect-timeout 10 -H "Host: clerikc.ru" http://$SERVER_IP/ && echo "‚úÖ HTTP —Å Host header –†–ê–ë–û–¢–ê–ï–¢!" || echo "‚ùå HTTP —Å Host header –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
        
        echo "=== 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTPS –Ω–∞ –ø–æ—Ä—Ç—É 443 ==="
        curl -vk --connect-timeout 10 https://$SERVER_IP:443/ && echo "‚úÖ HTTPS –Ω–∞ –ø–æ—Ä—Ç—É 443 –æ—Ç–≤–µ—á–∞–µ—Ç!" || echo "‚ùå HTTPS –Ω–∞ –ø–æ—Ä—Ç—É 443 –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

    - name: üîç Debug if Failed
      if: failure()
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "=== –î–ï–¢–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ==="
        kubectl describe service -n ingress-nginx
        kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx --tail=20
        kubectl get ingress -A
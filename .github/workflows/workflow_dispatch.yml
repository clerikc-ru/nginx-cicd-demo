name: üîç Test Ingress Access

on:
  workflow_dispatch:
  push:
    tags:
      - 'v-*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üîß Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: üîê Load Kubeconfig
      run: |
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > /tmp/kubeconfig.yaml
        export KUBECONFIG=/tmp/kubeconfig.yaml
        kubectl get nodes

    - name: üèóÔ∏è Deploy Infrastructure
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "=== Deploying Infrastructure ==="
        kubectl apply -f k8s/infrastructure/ingress-controller.yaml
        sleep 10

    - name: üõ†Ô∏è Deploy Test Application
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        
        echo "=== Deploying Test Application ==="
        kubectl create configmap nginx-html --from-file=html/index.html -o yaml --dry-run=client | kubectl apply -f -
        kubectl create configmap nginx-config --from-file=nginx-config/nginx.conf -o yaml --dry-run=client | kubectl apply -f -
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        
        echo "‚è≥ Waiting for application..."
        sleep 20

    

    - name: üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ingress
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        
        echo "=== 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã ==="
        kubectl get pods -A
        kubectl get services -A
        kubectl get ingress -A
        
        echo "=== 2. –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ingress-nginx ==="
        kubectl describe pod -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
        kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx --tail=20
        
        echo "=== 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ==="
        kubectl get pods -l app=nginx-cicd-demo
        kubectl describe pod -l app=nginx-cicd-demo
        kubectl logs -l app=nginx-cicd-demo --tail=10
        
        echo "=== 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–∏—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ==="
        kubectl get service nginx-cicd-demo
        kubectl describe service nginx-cicd-demo
        
        echo "=== 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º –í–ù–£–¢–†–ò –∫–ª–∞—Å—Ç–µ—Ä–∞ ==="
        kubectl run test-curl --image=curlimages/curl --rm -i --restart=Never --command -- \
          sh -c 'echo "=== –¢–µ—Å—Ç —Å–µ—Ä–≤–∏—Å–∞ ===" && \
                 curl -v http://nginx-cicd-demo.default.svc.cluster.local && \
                 echo "=== –¢–µ—Å—Ç ingress ===" && \
                 curl -v -H "Host: clerikc.ru" http://ingress-nginx-controller.ingress-nginx.svc.cluster.local'

    - name: üîç Debug if Failed
      if: failure()
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "=== –î–ï–¢–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ==="
        kubectl describe service -n ingress-nginx
        kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx --tail=20
        kubectl get ingress -A
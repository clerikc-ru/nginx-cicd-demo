name: üîç Test Ingress Controller

on:
  workflow_dispatch:  # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ UI GitHub
  push:
    tags:
      - 'v-*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üîß Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: üîê Load Kubeconfig
      run: |
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > /tmp/kubeconfig.yaml
        export KUBECONFIG=/tmp/kubeconfig.yaml
        kubectl get nodes

    - name: üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Ingress Controller
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        
        echo "=== 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º Ingress Controller ==="
        kubectl get service -n ingress-nginx
        
        echo "=== 2. –ñ–¥–µ–º –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ IP ==="
        timeout 180s bash -c 'while [[ $(kubectl get service -n ingress-nginx ingress-nginx-controller -o jsonpath="{.status.loadBalancer.ingress[0].ip}") == "" ]]; do sleep 5; echo "–û–∂–∏–¥–∞–µ–º External IP..."; done'
        
        EXTERNAL_IP=$(kubectl get service -n ingress-nginx ingress-nginx-controller -o jsonpath="{.status.loadBalancer.ingress[0].ip}")
        echo "‚úÖ External IP: $EXTERNAL_IP"
        
        echo "=== 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTP –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å ==="
        curl -f http://$EXTERNAL_IP || echo "‚ùå HTTP –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
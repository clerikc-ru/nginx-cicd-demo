name: ğŸ”„ Update HTML Content

on:
  push:
    paths:
      - 'html/index.html'
    branches: [main]

jobs:
  update-html:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: ğŸ” Configure Kubernetes access
      run: |
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > /tmp/kubeconfig.yaml
        export KUBECONFIG=/tmp/kubeconfig.yaml

    - name: ğŸ—‚ï¸ Update HTML ConfigMap
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "ğŸ”„ Updating HTML content..."
        kubectl create configmap nginx-html --from-file=html/index.html -o yaml --dry-run=client | kubectl apply -f -
        echo "âœ… HTML ConfigMap updated successfully"

    - name: ğŸ”„ Restart Pods to apply changes
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "ğŸ”„ Restarting pods to apply HTML changes..."
        kubectl rollout restart deployment/nginx-cicd-demo
        kubectl rollout status deployment/nginx-cicd-demo --timeout=90s
        echo "âœ… Pods restarted with new HTML content"

    - name: âœ… Verify Update
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "ğŸ” Verifying HTML update..."
        kubectl get configmap nginx-html -o jsonpath='{.data.index\.html}' | head -5
        echo "âœ… HTML content updated and deployed!"
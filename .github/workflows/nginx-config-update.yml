name: ğŸ”§ Update Configuration

on:
  push:
    tags:
      - 'config-update-*'
    # Ğ£Ğ±Ñ€Ğ°Ğ»Ğ¸ paths - Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¿Ğ¾ Ñ‚ĞµĞ³Ğ°Ğ¼

jobs:
  update-config:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: ğŸ” Configure Kubernetes access
      run: |
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > /tmp/kubeconfig.yaml
        export KUBECONFIG=/tmp/kubeconfig.yaml

    - name: ğŸ—‚ï¸ Update ConfigMaps
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "ğŸ”„ Updating ConfigMaps..."
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ HTML ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
        kubectl create configmap nginx-html --from-file=html/index.html -o yaml --dry-run=client | kubectl apply -f -
        echo "âœ… HTML ConfigMap updated"
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
        kubectl create configmap nginx-config --from-file=nginx-config/nginx.conf -o yaml --dry-run=client | kubectl apply -f -
        echo "âœ… Nginx ConfigMap updated"

    - name: ğŸ”„ Restart Pods
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "ğŸ”„ Restarting pods to apply configuration changes..."
        kubectl rollout restart deployment/nginx-cicd-demo
        kubectl rollout status deployment/nginx-cicd-demo --timeout=120s
        echo "âœ… Pods restarted successfully"

    - name: âœ… Verify Configuration
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "ğŸ” Verifying configuration update..."
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ConfigMaps
        kubectl get configmap nginx-html nginx-config
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ endpoints (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
        echo "ğŸ§ª Testing endpoints..."
        curl -f https://clerikc.ru/health && echo "âœ… Health endpoint works" || echo "âš ï¸ Health endpoint check skipped"
        curl -f https://clerikc.ru/ && echo "âœ… Main page works" || echo "âŒ Main page failed"
        
        echo "ğŸ‰ Configuration updated successfully!"
        echo "ğŸŒ Check your site: https://clerikc.ru"
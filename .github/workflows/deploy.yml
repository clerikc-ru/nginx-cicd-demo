name: üìà Deploy with SSL

on:
  push:
    tags:
      - 'v-*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üîß Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: üîê Load Kubeconfig
      run: |
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > /tmp/kubeconfig.yaml
        export KUBECONFIG=/tmp/kubeconfig.yaml
        kubectl get nodes

    - name: üèóÔ∏è Deploy Infrastructure (SSL)
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        
        echo "=== Deploying SSL Infrastructure ==="
        kubectl apply -f k8s/infrastructure/
        
        echo "‚è≥ Waiting for infrastructure to be ready..."
        sleep 60  # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ Ingress Controller –∏ Cert Manager

    - name: üõ†Ô∏è Deploy Application with SSL
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        
        echo "=== Creating ConfigMaps ==="
        kubectl create configmap nginx-html --from-file=html/index.html -o yaml --dry-run=client | kubectl apply -f -
        kubectl create configmap nginx-config --from-file=nginx-config/nginx.conf -o yaml --dry-run=client | kubectl apply -f -
        
        echo "=== Applying Application with SSL ==="
        kubectl apply -f k8s/
        
        echo "‚è≥ Waiting for SSL certificate issuance..."
        sleep 30
        
        echo "‚úÖ Application deployed with SSL!"

    - name: üß™ Test SSL
      run: |
        echo "Testing SSL deployment..."
        curl -f https://clerikc.ru && echo "‚úÖ HTTPS works!" || echo "‚ùå HTTPS failed"
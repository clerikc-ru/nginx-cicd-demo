name: üìà Deploy

on:
  push:
    tags:
      - 'v-*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üîß Setup kubectl
      uses: azure/setup-kubectl@v3

    - name: üîê Load Kubeconfig CORRECTLY
      run: |
        echo "=== STEP 1: Create kubeconfig from secret ==="
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > /tmp/kubeconfig.yaml
        echo "File created at: /tmp/kubeconfig.yaml"
        
        echo "=== STEP 2: Set KUBECONFIG with absolute path ==="
        export KUBECONFIG=/tmp/kubeconfig.yaml
        echo "KUBECONFIG is: $KUBECONFIG"
        
        echo "=== STEP 3: Test connection ==="
        kubectl cluster-info
        kubectl get nodes

        - name: üõ†Ô∏è Deploy Application with Monitoring
      run: |
        export KUBECONFIG=/tmp/kubeconfig.yaml
        
        echo "=== Creating ConfigMaps from files ==="
        kubectl create configmap nginx-html --from-file=html/index.html -o yaml --dry-run=client | kubectl apply -f -
        kubectl create configmap nginx-config --from-file=nginx-config/nginx.conf -o yaml --dry-run=client | kubectl apply -f -
        kubectl create configmap metrics-script --from-file=scripts/metrics-server.py -o yaml --dry-run=client | kubectl apply -f -
        
        echo "=== Applying Kubernetes manifests ==="
        kubectl apply -f k8s/
        
        echo "=== Restarting pods to pick up monitoring changes ==="
        kubectl rollout restart deployment/nginx-cicd-demo
        kubectl rollout status deployment/nginx-cicd-demo --timeout=300s
        
        echo "‚úÖ Application deployed with real-time monitoring!"
    - name: üß™ Test
      run: |
        echo "Testing deployment..."
        curl -f http://185.8.22.53:30000 && echo "‚úÖ Main page works!"
        curl -f http://185.8.22.53:30000/status && echo "‚úÖ Status page works!"
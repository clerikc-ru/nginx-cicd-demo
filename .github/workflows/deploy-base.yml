name: Base Kubernetes Deploy

on:
  workflow_call:
    inputs:
      k8s_manifests_path:
        required: true
        type: string
      app_name:
        required: true
        type: string
      test_url:
        required: false
        type: string

jobs:
  deploy-kubernetes:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Kubernetes tools
      uses: azure/setup-kubectl@v3

    - name: ğŸ” Configure Kubernetes context
      run: |
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > kubeconfig.yaml
        export KUBECONFIG=kubeconfig.yaml
        
        echo "ğŸ” Testing cluster connection..."
        kubectl cluster-info
        kubectl get nodes

    - name: ğŸ·ï¸ Extract version info
      id: version
      run: |
        # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ¸Ğ· Ñ‚ĞµĞ³Ğ° Ğ¸Ğ»Ğ¸ Ğ²ĞµÑ‚ĞºĞ¸
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "ğŸš€ Deploying version: $VERSION"
        else
          VERSION="${{ github.sha }}"
          echo "ğŸš€ Deploying commit: $VERSION"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: ğŸ› ï¸ Deploy application
      run: |
        export KUBECONFIG=kubeconfig.yaml
        
        echo "ğŸš€ Deploying ${{ inputs.app_name }} (Version: ${{ steps.version.outputs.version }})"
        
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¼ĞµÑ‚ĞºÑƒ Ñ Ğ²ĞµÑ€ÑĞ¸ĞµĞ¹
        kubectl apply -f ${{ inputs.k8s_manifests_path }}
        kubectl label deployment/${{ inputs.app_name }} version="${{ steps.version.outputs.version }}" --overwrite
        
        kubectl rollout status deployment/${{ inputs.app_name }} --timeout=300s
        echo "âœ… Application deployed!"

    - name: ğŸ§ª Test deployment
      if: inputs.test_url != ''
      run: |
        echo "ğŸ§ª Testing: ${{ inputs.test_url }}"
        echo "ğŸ“‹ Version: ${{ steps.version.outputs.version }}"
        curl -f "${{ inputs.test_url }}" && echo "âœ… Test passed!" || echo "âŒ Test failed"
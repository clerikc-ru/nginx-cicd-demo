<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kubernetes Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ + –Ω–æ–≤—ã–µ */
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 15px;
            color: #374151;
            font-size: 1.2em;
        }
        
        .real-time-badge {
            background: #10b981;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .metrics-history {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .history-table th,
        .history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .history-table th {
            background: rgba(16, 185, 129, 0.1);
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üöÄ Kubernetes Monitoring Dashboard <span class="real-time-badge">LIVE</span></h1>
            <p>Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
            <div style="margin-top: 10px; font-size: 0.9em;">
                –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update">--:--:--</span>
            </div>
        </div>
        
        <div class="status-grid">
            <div class="status-card">
                <div class="status-header">
                    <div class="status-indicator status-online"></div>
                    <h3>–í–µ–±-—Å–µ—Ä–≤–µ—Ä Nginx</h3>
                </div>
                <p>–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã</p>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value" id="total-connections">0</div>
                        <div class="metric-label">–í—Å–µ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="active-connections">0</div>
                        <div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ–π—á–∞—Å</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="requests-per-sec">0</div>
                        <div class="metric-label">–ó–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫</div>
                    </div>
                </div>
            </div>
            
            <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏ -->
        </div>
        
        <!-- –ì–†–ê–§–ò–ö–ò -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">üìà –ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</div>
                <canvas id="connectionsChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">üî• –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>
                <canvas id="activeChart"></canvas>
            </div>
        </div>
        
        <!-- –¢–ê–ë–õ–ò–¶–ê –ò–°–¢–û–†–ò–ò -->
        <div class="metrics-history">
            <h3>üìã –ò—Å—Ç–æ—Ä–∏—è –º–µ—Ç—Ä–∏–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π)</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–í—Å–µ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π</th>
                        <th>–ê–∫—Ç–∏–≤–Ω—ã–µ</th>
                        <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="history-table-body">
                    <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- –û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å HTML -->
    </div>

    <script>
        // –ì—Ä–∞—Ñ–∏–∫–∏
        const connectionsCtx = document.getElementById('connectionsChart').getContext('2d');
        const activeCtx = document.getElementById('activeChart').getContext('2d');
        
        const connectionsChart = new Chart(connectionsCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '–í—Å–µ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        const activeChart = new Chart(activeCtx, {
            type: 'line', 
            data: {
                labels: [],
                datasets: [{
                    label: '–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        let previousConnections = 0;
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        async function updateMetrics() {
            try {
                const response = await fetch('/metrics');
                const data = await response.json();
                
                if (data.current) {
                    const { connections, active_connections, timestamp } = data.current;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
                    document.getElementById('total-connections').textContent = connections;
                    document.getElementById('active-connections').textContent = active_connections;
                    document.getElementById('last-update').textContent = new Date(timestamp).toLocaleTimeString();
                    
                    // –°—á–∏—Ç–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –≤ —Å–µ–∫—É–Ω–¥—É
                    const requestsPerSec = connections - previousConnections;
                    document.getElementById('requests-per-sec').textContent = Math.max(0, requestsPerSec);
                    previousConnections = connections;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                    updateCharts(data.history);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏
                    updateHistoryTable(data.history);
                }
            } catch (error) {
                console.log('Metrics update failed:', error);
            }
        }
        
        function updateCharts(history) {
            const timestamps = history.timestamps.map(ts => 
                new Date(ts).toLocaleTimeString()
            );
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –æ–±—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
            connectionsChart.data.labels = timestamps;
            connectionsChart.data.datasets[0].data = history.connections;
            connectionsChart.update();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π  
            activeChart.data.labels = timestamps;
            activeChart.data.datasets[0].data = history.active_connections;
            activeChart.update();
        }
        
        function updateHistoryTable(history) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π
            const recentData = history.timestamps.slice(-10).map((timestamp, index) => ({
                timestamp,
                connections: history.connections[history.connections.length - 10 + index],
                active: history.active_connections[history.active_connections.length - 10 + index]
            }));
            
            recentData.forEach((item, index) => {
                const prevConnections = index > 0 ? recentData[index - 1].connections : item.connections;
                const change = item.connections - prevConnections;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(item.timestamp).toLocaleTimeString()}</td>
                    <td>${item.connections}</td>
                    <td>${item.active}</td>
                    <td style="color: ${change >= 0 ? '#10b981' : '#ef4444'}">
                        ${change >= 0 ? '+' : ''}${change}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        updateMetrics();
        setInterval(updateMetrics, 2000);
    </script>
</body>
</html>